function init(){window.init()}var app=angular.module("app",["ngSanitize","youtubeModule","spotifyModule","helperModule","ui.select"]);app.filter("propsFilter",function(){return function(e,t){var i=[];return angular.isArray(e)?e.forEach(function(e){for(var o=!1,s=Object.keys(t),n=0;n<s.length;n++){var r=s[n],a=t[r].toLowerCase();if(-1!==e[r].toString().toLowerCase().indexOf(a)){o=!0;break}}o&&i.push(e)}):i=e,i}}),app.controller("appCtrl",["$scope","$rootScope","$q","$window","$location","Spotify","Youtube","Helper",function(e,t,i,o,s,n,r,a){e.gapiReady=!1,e.isLoggedIn=!1,o.init=function(){r.setupApi(),e.gapiReady=!0,r.checkAuth().then(function(t){e.isLoggedIn=t===!0?!0:!1})},t.spotify={},t.youtube={},t.youtube.gapiReady=!1,t.youtube.user=!1,t.spotify.user=!1,t.spotify.noLogin=!1,n.getAccessToken(),console.log(n.isValidAccessToken()),e.spotify.login=function(){n.login()},(e.spotify.getPlaylists=function(){return t.loading=!0,n.isValidAccessToken()?void n.getUser().then(function(e){return e=e.data,console.log(e),n.getUserPlaylists(e)}).then(function(i){i=i.data,e.playlists=i.items,console.log(e.playlists),t.loading=!1}):void(t.loading=!1)})(),e.spotify.selectPlaylist=function(){if(t.loading=!0,console.log(e.spotify.nowPlaying),e.spotify.nowPlaying){var i=e.spotify.nowPlaying,o=i.id,s=i.owner.id;n.getUserPlaylistSongs(o,s).then(function(e){return e=e.data,console.log(e),a.getTracksInfo(e,1)}).then(function(t){e.youtube.searchVideos(t)})}},e.youtube.login=function(){r.login().then(function(e){t.youtube.user=!0},function(e){t.error=e})},e.youtube.searchVideos=function(o){var s=[],n=[];angular.forEach(o,function(e,t){s.push(r.searchVideo(e))}),i.all(s).then(function(i){angular.forEach(o,function(e,t){o[t].youtubeId=i[t].result.items[0].id.videoId,n.push(o[t].youtubeId)}),e.results=o,e.youtubeIds=n,t.loading=!1})}}]);var services=angular.module("helperModule",[]);services.service("Helper",["$q",function(e){this.parseHashbangResponse=function(e){console.log(e);var e=e||"";if(2!==e.split("/").length)return!1;if(""===e.split("/")[1])return!1;var t=e.split("/")[1].split("&");return{accessToken:t[0].split("=")[1],token_type:t[1].split("=")[1],expires_in:t[2].split("=")[1]}},this.extractSpotifyId=function(e){var t=[];return e=e.split(/\n/),angular.forEach(e,function(e){var i=0,o=e.trim().split(":");if(i="http"===o[0]?1:"spotify"===o[0]?2:0,0===i)console.log("Url "+e.trim()+" is not valid!");else{var s=o[o.length-1].split("/");s=s[s.length-1],t.push(s)}}),t},this.getTracksInfo=function(t,i){var o=[];if(0===i){console.log(t);for(var s=0;s<t.length;s+=1)if(t[s]){for(var n=[],r=0;r<t[s].artists.length;r+=1)n.push(t[s].artists[r].name);n=n.join(", "),o.push({album:t[s].album,artists:n,name:t[s].name,spotifyUrl:t[s].external_urls.spotify})}}else if(1===i){t=t.items;for(var s=0;s<t.length;s+=1)if(t[s]){for(var a=t[s].track,n=[],r=0;r<a.artists.length;r+=1)n.push(a.artists[r].name);n=n.join(", "),o.push({album:a.album,artists:n,name:a.name,spotifyUrl:a.external_urls.spotify})}}return e.when(o)},this.sleep=function(e){for(var t=(new Date).getTime(),i=0;1e7>i&&!((new Date).getTime()-t>e);i++);}}]);var services=angular.module("spotifyModule",["helperModule"]);services.service("Spotify",["$rootScope","$q","$http","Helper","$location",function(e,t,i,o,s){this.isValidAccessToken=function(){if(!e.spotify.user)return!1;var t=Math.round((new Date).getTime()/1e3),i=e.spotify.user.expires;return i>t?!0:!1},this.getAccessToken=function(){var t=Math.round((new Date).getTime()/1e3);this.isValidAccessToken()||(e.spotify.user=o.parseHashbangResponse(s.url()),e.spotify.user&&(e.spotify.user.expires=t+e.spotify.user.expires_in))},this.login=function(){window.location="https://accounts.spotify.com/authorize?client_id=60cd0e4b101b40ab9ef2d407c4962149&response_type=token&redirect_uri=http%3A%2F%2Fmacbook-di-marco.local%3A5757"},this.getUser=function(){return i.get("https://api.spotify.com/v1/me",{headers:{Authorization:"Bearer "+e.spotify.user.accessToken}})},this.getUserPlaylists=function(t){return i.get("https://api.spotify.com/v1/users/"+t.id+"/playlists",{headers:{Authorization:"Bearer "+e.spotify.user.accessToken}})},this.getUserPlaylistSongs=function(t,o){return i.get("https://api.spotify.com/v1/users/"+o+"/playlists/"+t+"/tracks",{headers:{Authorization:"Bearer "+e.spotify.user.accessToken},params:{fields:"items.track"}})},this.getTracks=function(e){var t=[],o=[],s=[];if(!(e.length>1e3)){if(e.length>50)for(var n=0,r=e.length;r>n;n+=50)t.push(e.slice(n,n+50));else t=[e];for(var a=0;a<t.length;a+=1)o.push(i.get("https://api.spotify.com/v1/tracks",{params:{ids:t[a].join()}}));return o}}}]);var services=angular.module("youtubeModule",["helperModule"]);services.service("Youtube",["$q","$window","Helper",function(e,t,i){this.clientId="743605158714-vfjtaobdqlgshs7157r43e1ohntdkbe6.apps.googleusercontent.com",this.scopes="https://www.googleapis.com/auth/youtube",this.setupApi=function(){gapi.client.setApiKey("AIzaSyBKB-CGWlr3id6q4SObfRPrYrAIHcACPuk"),t.setTimeout(this.checkAuth,1)},this.checkAuth=function(){var t=e.defer();return gapi.auth.authorize({client_id:this.clientId,scope:this.scopes,immediate:!0},function(e){t.resolve(e&&!e.error?!0:e?e.error:!1)}),t.promise},this.login=function(t){var i=e.defer();return gapi.auth.authorize({client_id:this.clientId,scope:this.scopes,immediate:!1},function(e){e&&!e.error?i.resolve(e):e?i.reject(e.error):i.resolve(!1)}),i.promise},this.createPlaylist=function(t){var i=e.defer(),o=gapi.client.youtube.playlists.insert({part:"snippet,status",resource:{snippet:{title:t,description:"A private playlist created with the YouTube API"},status:{privacyStatus:"private"}}});return o.execute(function(e){var t=e.result;i.resolve(t?t:!1)}),i.promise},this.addVideoToPlaylist=function(t,i){var o=e.defer(),s={videoId:id,kind:"youtube#video"},n=gapi.client.youtube.playlistItems.insert({part:"snippet",resource:{snippet:{playlistId:i,resourceId:s}}});return n.execute(function(e){o.resolve(result)}),o.promise},this.loadApi=function(e){gapi.client?gapi.client.youtube?e():gapi.client.load("youtube","v3",function(){e()}):(i.sleep(2e3),console.info("waiting for Google API to be loaded"),this.loadApi(e))},this.searchVideo=function(t){var i=e.defer();return this.loadApi(function(){var e=t.artists+" "+t.name,o=gapi.client.youtube.search.list({q:e,part:"id"});o.then(function(e){i.resolve(e)})}),i.promise},this.searchVideos=function(t){var i=[];return angular.forEach(t,function(e){this.searchVideo(e).then(function(e){i.push(e)})}),e.when(i)}}]),services.directive("youtube",["$window",function(e){return{restrict:"E",scope:{height:"@",width:"@",videoid:"="},template:"<div></div>",link:function(t,i){var o=document.createElement("script");o.src="https://www.youtube.com/iframe_api";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(o,s);var n;e.onYouTubeIframeAPIReady=function(){n=new YT.Player(i.children()[0],{playerVars:{autoplay:1,html5:1,theme:"light",modesbranding:1,color:"white",iv_load_policy:3,showinfo:1,controls:1},height:400,width:1140})},t.$watch("videoid",function(e,i){e!=i&&""!==e&&e!==[]&&(console.log(e),n.loadPlaylist({playlist:t.videoid}))}),t.$watch("height + width",function(e,i){e!=i&&n.setSize(t.width,t.height)})}}}]);